With guichets_filter as (select * 
		from guichets
		where guichet_statut in (1,3)
		and top_sup=false),
	tiers_guichets_filter as (select *
		from relation_tiers_guichets
		where top_sup= false
		and NATURE_LIEN_PP_PM_CG in ('01','05','07')),
	tiers_filter as (select * 
		from tiers
		where top_sup=false
		and natu_tiers='1'
		and type_tiers in ('01','02','04')
		and top_banque_prive in ('005', '009')),
	prestation_filter as ( select * 
						   from prestations
						   where top_sup = false
						   and code_source='001'),
						   
	detected as (select id_tiers, code_opt_facturation
				from prestation_filter
				where ( exists (select 1 from tiers_filter
							  where top_pp_pm = 'PP'
							  and type_tiers = '01'
							  and prestation_filter.id_tiers = tiers_filter.id_tiers
							  and exists (select 1 from tiers_guichets_filter
											where NATURE_LIEN_PP_PM_CG='01'
											and tiers_filter.id_tiers = tiers_guichets_filter.id_tiers
											and code_banque||code_guichet||num_client in (select code_banque||code_guichet||num_client
																						  from guichets_filter
																						  where type_cli in ('01','21','22','23'))))


						Or exists (select 1 from tiers_filter
							  where top_pp_pm = 'PM'
							  and type_tiers = '04'
							  and prestation_filter.id_tiers = tiers_filter.id_tiers
							  and exists (select 1 from tiers_guichets_filter
											where NATURE_LIEN_PP_PM_CG='07'
											and tiers_filter.id_tiers = tiers_guichets_filter.id_tiers
											and code_banque||code_guichet||num_client in (select code_banque||code_guichet||num_client
																						  from guichets_filter
																						  where type_cli in ('02','34','35'))))															
						Or exists (select 1 from tiers_filter
							  where top_pp_pm = 'PM'
							  and type_tiers = '02'
							  and prestation_filter.id_tiers = tiers_filter.id_tiers
							  and exists (select 1 from tiers_guichets_filter
											where NATURE_LIEN_PP_PM_CG='05'
											and tiers_filter.id_tiers = tiers_guichets_filter.id_tiers
											and code_banque||code_guichet||num_client in (select code_banque||code_guichet||num_client
																						  from guichets_filter
																						  where type_cli='08')))
					))
select id_tiers, code_opt_facturation, 'create' status
from detected
where not exists (select 1 from eligibilite
				 where detected.id_tiers = eligibilite.id_tiers)
union
select id_tiers , null , 'delete' status
from eligibilite 
where not exists (select 1 from detected
				 where detected.id_tiers = eligibilite.id_tiers)
																						  
																						  
																						  
